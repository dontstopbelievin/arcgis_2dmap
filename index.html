<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/html4/strict.dtd">
<html>

<head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="initial-scale=1, maximum-scale=1,user-scalable=no">
    <title>ArcGIS API for JavaScript: Map/MapAlm</title>
    <link rel="stylesheet" href="https://js.arcgis.com/3.25/esri/css/esri.css">
    <link rel="stylesheet" href="/css/styles.css">
    <script src="https://js.arcgis.com/3.25/"></script>
    <script type="text/javascript">
        var map;
        var timer;
        /* Get the documentElement (<html>) to display the page in fullscreen */
        var elem = document.documentElement;
        require([
            "dojo/dom",
            "dojo/on",
            "dojo/dom-construct",
            "esri/dijit/Search",
            "esri/layers/ArcGISDynamicMapServiceLayer",
            "esri/layers/ArcGISTiledMapServiceLayer",
            "esri/layers/FeatureLayer",
            "esri/InfoTemplate",
            "esri/map",
            "dojo/parser",
            "dojo/string",
            "esri/symbols/SimpleFillSymbol",
            "esri/symbols/SimpleLineSymbol",
            "esri/tasks/IdentifyTask",
            "esri/tasks/IdentifyParameters",
            "esri/dijit/Popup",
            "dojo/_base/array",
            "esri/Color",
            "esri/geometry/webMercatorUtils",
            "esri/dijit/Scalebar",
            "esri/dijit/HomeButton",
            "esri/dijit/LocateButton",
            "esri/dijit/LayerList",
            "dojo/domReady!"
        ], function(dom, on, domConstruct, Search, ArcGISDynamicMapServiceLayer, ArcGISTiledMapServiceLayer, FeatureLayer, InfoTemplate, Map, parser, string,
        SimpleFillSymbol, SimpleLineSymbol, IdentifyTask, IdentifyParameters, Popup, arrayUtils, Color, webMercatorUtils, Scalebar, HomeButton, LocateButton,
        LayerList) {
            parser.parse();

            var identifyTask, identifyParams;

            var popup = new Popup({
              fillSymbol: new SimpleFillSymbol(SimpleFillSymbol.STYLE_SOLID,
                new SimpleLineSymbol(SimpleLineSymbol.STYLE_SOLID,
                  new Color([255, 0, 0]), 2), new Color([255, 255, 0, 0.25]))
            }, domConstruct.create("div"));

            var map = new Map("map",{
              scale: 250000,
              infoWindow: popup,
              maxScale: 100,
              minScale: 250000
            });

            var search = new Search({
              enableButtonMode: true, //this enables the search widget to display as a single button
              enableLabel: false,
              enableInfoWindow: true,
              showInfoWindowOnSelect: true,
              map: map,
              sources: []
            }, "search");

            var sources = search.get("sources");
            sources.push({
              featureLayer: new FeatureLayer("https://gis.uaig.kz:6443/arcgis/rest/services/Map/MapAlm/MapServer/2"),
              searchFields: ["address"],
              displayField: "address",
              exactMatch: false,
              outFields: ["*"],
              name: "Здания и сооружения",
              placeholder: "пример: Ауэзова",
              maxResults: 6,
              maxSuggestions: 6,
              infoTemplate: new InfoTemplate("Здания и сооружения", `<table>
                <tr><td class="attrName">Адрес:</td>  <td class="attrValue">`+"${address}"+`</td></tr>
                <tr><td class="attrName">Этажность:</td>  <td class="attrValue">`+"${FLOOR}"+`</td></tr>
                <tr><td class="attrName">Год постройки:</td>  <td class="attrValue">`+"${YEAR_OF_FO}"+`</td></tr>
                <tr><td class="attrName">Функциональное назначение:</td>  <td class="attrValue">`+"${NAME}"+`</td></tr>
                <tr><td class="attrName">Площадь постройки:</td>  <td class="attrValue">`+"${ZASTR_AREA}"+`</td></tr>
                <tr><td class="attrName">Общая площадь:</td>  <td class="attrValue">`+"${OBSCH_AREA}"+`</td></tr>
                <tr><td class="attrName">Материал строения:</td>  <td class="attrValue">`+"${MATERIAL}"+`</td></tr>
                <tr><td class="attrName">Комментарий:</td>  <td class="attrValue">`+"${NOTE}"+`</td></tr>
                <tr><td class="attrName">Ссылка:</td>  <td class="attrValue">`+"<a target='_blank' href='${links}'>Подробнее</a>"+`</td></tr>
              </table>`),
              enableSuggestions: true,
              minCharacters: 0,
              autoNavigate:false
            });
            sources.push({
              featureLayer: new FeatureLayer("https://gis.uaig.kz:6443/arcgis/rest/services/Map/MapAlm/MapServer/69"),
              searchFields: ["KAD_N"],
              displayField: "KAD_N",
              exactMatch: false,
              outFields: ["*"],
              name: "Кадастровый номер",
              placeholder: "введите кадастровый номер",
              maxResults: 6,
              maxSuggestions: 6,
              infoTemplate: new InfoTemplate("Кадастровый номер", `<table>
                <tr><td class="attrName">Кадастровый номер:</td>  <td class="attrValue">`+"${KAD_N}"+`</td></tr>
                <tr><td class="attrName">Код района:</td>  <td class="attrValue">`+"${CodeR}"+`</td></tr>
                <tr><td class="attrName">Адрес:</td>  <td class="attrValue">`+"${Adress}"+`</td></tr>
                <tr><td class="attrName">Целевое назначение</td>  <td class="attrValue">`+"${Funk}"+`</td></tr>
                <tr><td class="attrName">Площадь зу:</td>  <td class="attrValue">`+"${S}"+`</td></tr>
                <tr><td class="attrName">Право:</td>  <td class="attrValue">`+"${right}"+`</td></tr>
              </table>`),
              enableSuggestions: true,
              minCharacters: 0
            });
            search.set("sources", sources);
            search.startup();

            map.on("load", mapReady);

            var layer;
            layer = new ArcGISDynamicMapServiceLayer("https://gis.uaig.kz:6443/arcgis/rest/services/Map/MapAlm/MapServer");
            map.addLayer(layer);

            var myWidget = new LayerList({
               map: map,
               layers: []
            },"layerList");
            myWidget.startup();

            var scalebar = new Scalebar({
              map: map,
              // "dual" displays both miles and kilometers
              // "english" is the default, which displays miles
              // use "metric" for kilometers
              scalebarUnit: "metric"
            });

            var home = new HomeButton({
              map: map
            }, "HomeButton");
            home.startup();

            geoLocate = new LocateButton({
              map: map
            }, "LocateButton");
            geoLocate.startup();

            var fulls = document.getElementById("fullscreen_button");
            var layers_button = document.getElementById("layers");
            function mapReady () {

              map.on("mouse-move", showCoordinates);
              map.on("mouse-drag", showCoordinates);

              fulls.style.visibility = "visible";
              fulls.addEventListener("click", openFullscreen);
              layers_button.style.visibility = "visible";

              on(search,'select-result', function(e) {
                console.log ('selected result', e);
                var pt = e.result.feature.geometry.getCentroid();
                this.map.centerAt(pt);
                console.log(pt);
                this.map.setScale(1000);
              });

              map.on("click", executeIdentifyTask);
              //create identify tasks and setup parameters
              identifyTask = new IdentifyTask('https://gis.uaig.kz:6443/arcgis/rest/services/Map/MapAlm/MapServer');

              identifyParams = new IdentifyParameters();
              identifyParams.tolerance = 3;
              identifyParams.returnGeometry = true;
              identifyParams.layerIds = [2];
              identifyParams.layerOption = IdentifyParameters.LAYER_OPTION_VISIBLE;
              identifyParams.width = map.width;
              identifyParams.height = map.height;
            }

            /* View in fullscreen */
            function openFullscreen() {
              if (elem.requestFullscreen) {
                elem.requestFullscreen();
              } else if (elem.mozRequestFullScreen) { /* Firefox */
                elem.mozRequestFullScreen();
              } else if (elem.webkitRequestFullscreen) { /* Chrome, Safari and Opera */
                elem.webkitRequestFullscreen();
              } else if (elem.msRequestFullscreen) { /* IE/Edge */
                elem.msRequestFullscreen();
              }
            }

            function showCoordinates(evt) {
              //the map is in web mercator but display coordinates in geographic (lat, long)
              var mp = webMercatorUtils.webMercatorToGeographic(evt.mapPoint);
              //display mouse coordinates
              dom.byId("info").innerHTML = mp.x.toFixed(3) + " " + mp.y.toFixed(3) + " Градусы";
            }

            function executeIdentifyTask (event) {
              clearTimeout(timer);
              identifyParams.geometry = event.mapPoint;
              identifyParams.mapExtent = map.extent;

              var deferred = identifyTask
                .execute(identifyParams)
                .addCallback(function (response) {
                  // response is an array of identify result objects
                  // Let's return an array of features.
                  if(response.length == 0){
                    timer = setTimeout(function(){map.infoWindow.hide(); }, 1000);
                  }
                  return arrayUtils.map(response, function (result) {
                    //console.log(result.feature);
                    var feature = result.feature;
                    var layerName = result.layerName;

                    feature.attributes.layerName = layerName;
                    if (layerName === 'Здания и сооружения') {
                      var my_link = "";
                      if(result.feature.attributes.ссылка != ""){
                          my_link = "<a target='_blank' href='${ссылка}'>Подробнее</a>";
                      }
                      var taxParcelTemplate = new InfoTemplate("${layerName}", `<table>
                        <tr><td class="attrName">Адрес:</td>  <td class="attrValue">`+"${Адрес}"+`</td></tr>
                        <tr><td class="attrName">Этажность:</td>  <td class="attrValue">`+"${Этажность}"+`</td></tr>
                        <tr><td class="attrName">Год постройки:</td>  <td class="attrValue">`+"${Год постройки}"+`</td></tr>
                        <tr><td class="attrName">Функциональное назначение:</td>  <td class="attrValue">`+"${Функциональное назначение}"+`</td></tr>
                        <tr><td class="attrName">Площадь постройки:</td>  <td class="attrValue">`+"${Площадь постройки}"+`</td></tr>
                        <tr><td class="attrName">Общая площадь:</td>  <td class="attrValue">`+"${Общая площадь}"+`</td></tr>
                        <tr><td class="attrName">Материал строения:</td>  <td class="attrValue">`+"${Материал строения}"+`</td></tr>
                        <tr><td class="attrName">Комментарий:</td>  <td class="attrValue">`+"${Комментарий}"+`</td></tr>
                        <tr><td class="attrName">Ссылка:</td>  <td class="attrValue">`+my_link+`</td></tr>
                      </table>`);
                      feature.setInfoTemplate(taxParcelTemplate);
                    }
                    return feature;
                  });
                });

              map.infoWindow.setFeatures([deferred]);
              map.infoWindow.show(event.mapPoint);
            }

        });
    </script>
</head>

<body class="tundra">
    <div data-dojo-type="dijit/layout/BorderContainer" design="headline" gutters="true" style="width: 100%; height: 100%; margin: 0;">
        <div data-dojo-type="dijit/layout/ContentPane" region="top" id="navtable">
        </div>
        <div id="layerListPane" data-dojo-type="dijit/layout/ContentPane" data-dojo-props="region:'right'">
            <div id="layerList"></div>
        </div>
        <div id="map" data-dojo-type="dijit/layout/ContentPane" region="center">
          <div id="search"></div>
          <span id="info"></span>
          <div id="HomeButton"></div>
          <div id="LocateButton"></div>
          <div id="fullscreen_button">
            <img src="/images/fulls.png" class="my_fulls">
          </div>
          <div id="layers">
            <img src="/images/layers.png" class="my_fulls">
          </div>
      </div>
    </div>
</body>
</html>
